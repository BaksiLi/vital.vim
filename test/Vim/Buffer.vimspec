scriptencoding utf-8

let s:V = vital#of('vital')
let s:P = s:V.import('System.Filepath')

Describe Vim.Buffer
  Before all
    let Buffer = s:V.import('Vim.Buffer')
  End
  After all
    windo bwipeout!
  End
  Before
    windo bwipeout!
  End

  Describe .is_cmdwin()
    It detects if current window is cmdwin.
      " FIXME: CmdWin can not open from test environment
      Assert Falsy(Buffer.is_cmdwin())
    End
  End

  Describe .get_last_selected()
    Context for single byte characters
      Before
        execute printf('edit %s',
              \ s:P.realpath('test/_testdata/Vim/Buffer/single.txt')
              \)
      End

      It can get the last selected text without textlock error.
        normal! ggVGygg
        let text = Buffer.get_last_selected()
        Assert Equals(text, "foo\nbar\nbaz\n")

        normal! ggvjly
        let text = Buffer.get_last_selected()
        Assert Equals(text, "foo\nba")

        execute "normal! gg\<C-v>jly"
        let text = Buffer.get_last_selected()
        Assert Equals(text, "fo\nba")
      End

      It can apply to oneline
        normal! ggVygg
        let text = Buffer.get_last_selected()
        Assert Equals("foo\n", text)

        normal! ggvly
        let text = Buffer.get_last_selected()
        Assert Equals("fo", text)

        execute "normal! gg\<C-v>ly"
        let text = Buffer.get_last_selected()
        Assert Equals("fo", text)
      End

      It does not destroy unnamed register content
        normal! ggVGy
        let @" = "ajapa-"
        call Buffer.get_last_selected()
        Assert Equals("ajapa-", @")
      End
    End

    Context for wide characters
      Before
        execute printf('edit %s',
              \ s:P.realpath('test/_testdata/Vim/Buffer/wide.txt')
              \)
      End

      It can apply to wide characters string
        normal! ggVGygg
        let text = Buffer.get_last_selected()
        Assert Equals("あいうえお\nかきくけこ\nほげら\n", text)

        normal! ggvjly
        let text = Buffer.get_last_selected()
        Assert Equals("あいうえお\nかき", text)

        execute "normal! gg\<C-v>jly"
        let text = Buffer.get_last_selected()
        Assert Equals("あい\nかき", text)
      End
    End
    Context for mixed characters
      Before
        execute printf('edit %s',
              \ s:P.realpath('test/_testdata/Vim/Buffer/mixed.txt')
              \)
      End

      It can apply to mixed string
        normal! ggVGygg
        let text = Buffer.get_last_selected()
        Assert Equals("あiうeお\nkaきkuけko\nほgeら\n", text)

        normal! ggvjly
        let text = Buffer.get_last_selected()
        Assert Equals("あiうeお\nka", text)

        execute "normal! gg\<C-v>jly"
        let text = Buffer.get_last_selected()
        Assert Equals("あ\nka", text)
      End

      It can apply to mixed oneline string
        normal! ggVygg
        let text = Buffer.get_last_selected()
        Assert Equals("あiうeお\n", text)

        normal! ggvly
        let text = Buffer.get_last_selected()
        Assert Equals("あi", text)

        execute "normal! gg\<C-v>ly"
        let text = Buffer.get_last_selected()
        Assert Equals("あi", text)
      End
    End
  End
End
